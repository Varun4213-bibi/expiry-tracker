{% extends 'base.html' %}

{% block title %}Profile - Expiry Tracker{% endblock %}

{% block content %}
<div class="container-fluid py-5" style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); min-height: 100vh;">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden" style="border: 1px solid #e9ecef;">
                <!-- Profile Header -->
                <div class="card-header bg-gradient-primary text-white text-center py-4" style="background: linear-gradient(45deg, #00050e, #043072);">
                    <div class="profile-avatar mb-3">
                        <div class="avatar-circle mx-auto" style="width: 100px; height: 100px; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2.5rem; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                            {{ user.first_name|first|default:user.username|first|upper }}
                        </div>
                    </div>
                    <h2 class="mb-1">{{ user.first_name|default:user.username }} {{ user.last_name }}</h2>
                    <p class="mb-0 opacity-75">{{ user.email }}</p>
                </div>

                <!-- Profile Body -->
                <div class="card-body p-4">
                    <h4 class="mb-4 text-center" style="color: #2c3e50; font-weight: 600;">Edit Profile Information</h4>

                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <div class="row g-3">
                            <!-- First Name -->
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control form-control-lg {% if form.first_name.errors %}is-invalid{% endif %}" id="{{ form.first_name.id_for_label }}" name="{{ form.first_name.name }}" value="{{ form.first_name.value|default_if_none:'' }}" placeholder="First Name" required>
                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                        <i class="fas fa-user me-2"></i>{{ form.first_name.label }}
                                    </label>
                                    {% if form.first_name.errors %}
                                        <div class="invalid-feedback">
                                            {{ form.first_name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Last Name -->
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control form-control-lg {% if form.last_name.errors %}is-invalid{% endif %}" id="{{ form.last_name.id_for_label }}" name="{{ form.last_name.name }}" value="{{ form.last_name.value|default_if_none:'' }}" placeholder="Last Name">
                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                        <i class="fas fa-user me-2"></i>{{ form.last_name.label }}
                                    </label>
                                    {% if form.last_name.errors %}
                                        <div class="invalid-feedback">
                                            {{ form.last_name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control form-control-lg {% if form.email.errors %}is-invalid{% endif %}" id="{{ form.email.id_for_label }}" name="{{ form.email.name }}" value="{{ form.email.value|default_if_none:'' }}" placeholder="Email Address" required>
                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                <i class="fas fa-envelope me-2"></i>{{ form.email.label }}
                            </label>
                            {% if form.email.errors %}
                                <div class="invalid-feedback">
                                    {{ form.email.errors.0 }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Email Reminders Toggle -->
                        <div class="card border-0 bg-light mb-4">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <h6 class="mb-1" style="color: #2c3e50;">
                                            <i class="fas fa-bell me-2 text-primary"></i>Email Reminders
                                        </h6>
                                        <small class="text-muted">Receive notifications for expiring items</small>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="{{ form.email_reminders_enabled.id_for_label }}" name="{{ form.email_reminders_enabled.name }}" {% if form.email_reminders_enabled.value %}checked{% endif %} style="width: 3em; height: 1.5em;">
                                        <label class="form-check-label visually-hidden" for="{{ form.email_reminders_enabled.id_for_label }}">
                                            {{ form.email_reminders_enabled.label }}
                                        </label>
                                    </div>
                                </div>
                                {% if form.email_reminders_enabled.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.email_reminders_enabled.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Push Notifications Toggle -->
                        <div class="card border-0 bg-light mb-4">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <h6 class="mb-1" style="color: #2c3e50;">
                                            <i class="fas fa-mobile-alt me-2 text-success"></i>Push Notifications
                                        </h6>
                                        <small class="text-muted">Receive real-time notifications on your device</small>
                                        <div id="push-notification-status" class="small mt-1" style="display: none; color: #6c757d;">
                                            <i class="fas fa-info-circle me-1"></i>Push notifications not supported in this browser
                                        </div>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="{{ form.push_reminders_enabled.id_for_label }}" name="{{ form.push_reminders_enabled.name }}" {% if form.push_reminders_enabled.value %}checked{% endif %} style="width: 3em; height: 1.5em;" onchange="handlePushNotificationToggle(this)">
                                        <label class="form-check-label visually-hidden" for="{{ form.push_reminders_enabled.id_for_label }}">
                                            {{ form.push_reminders_enabled.label }}
                                        </label>
                                    </div>
                                </div>
                                {% if form.push_reminders_enabled.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.push_reminders_enabled.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>



                        <!-- Status Message Area -->
                        <div id="push-notification-status" style="display: none;"></div>

                        <!-- Submit Button -->



                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm" style="background: linear-gradient(45deg, #667eea, #090112); border: none; padding: 12px 30px; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                        </div>
                    </form>

                    <!-- Additional Info -->
                    <div class="text-center mt-4">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Your profile information is kept secure and private.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .avatar-circle {
        transition: transform 0.3s ease;
    }
    .avatar-circle:hover {
        transform: scale(1.1);
    }
    .form-floating > .form-control {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    .form-floating > .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    .card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }
</style>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- Push Notification Integration Script -->
<script>
let pushManager = null;

async function initPushNotifications() {
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        try {
            const registration = await navigator.serviceWorker.register('/static/js/service-worker.js');
            console.log('Service Worker registered for push notifications');

            pushManager = {
                registration: registration,
                isSubscribed: false,
                vapidPublicKey: null
            };

            // Get VAPID public key
            await getVapidPublicKey();

            // Check current subscription status
            const subscription = await registration.pushManager.getSubscription();
            pushManager.isSubscribed = !(subscription === null);

            return true;
        } catch (error) {
            console.error('Service Worker registration failed:', error);
            return false;
        }
    } else {
        console.warn('Push notifications not supported');
        return false;
    }
}

async function getVapidPublicKey() {
    try {
        const response = await fetch('/api/notifications/vapid-public-key/');
        if (response.ok) {
            const data = await response.json();
            if (pushManager) {
                pushManager.vapidPublicKey = data.public_key;
            }
        }
    } catch (error) {
        console.error('Failed to get VAPID public key:', error);
    }
}

async function requestNotificationPermission() {
    if ('Notification' in window) {
        const permission = await Notification.requestPermission();
        return permission === 'granted';
    }
    return false;
}

async function subscribeToPushNotifications() {
    if (!pushManager || !pushManager.registration) return false;

    try {
        const subscription = await pushManager.registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(pushManager.vapidPublicKey)
        });

        // Send subscription to server
        const response = await fetch('/api/notifications/subscribe/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                subscription: subscription.toJSON()
            })
        });

        if (response.ok) {
            pushManager.isSubscribed = true;
            console.log('Successfully subscribed to push notifications');
            return true;
        } else {
            console.error('Failed to subscribe on server');
            return false;
        }
    } catch (error) {
        console.error('Failed to subscribe to push notifications:', error);
        return false;
    }
}

async function unsubscribeFromPushNotifications() {
    if (!pushManager || !pushManager.registration) return false;

    try {
        const subscription = await pushManager.registration.pushManager.getSubscription();
        if (subscription) {
            const result = await subscription.unsubscribe();

            if (result) {
                // Notify server
                await fetch('/api/notifications/unsubscribe/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        endpoint: subscription.endpoint
                    })
                });

                pushManager.isSubscribed = false;
                console.log('Successfully unsubscribed from push notifications');
                return true;
            }
        }
    } catch (error) {
        console.error('Failed to unsubscribe from push notifications:', error);
    }
    return false;
}

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');

    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);

    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}


function getCsrfToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    if (token) {
        return token.getAttribute('content');
    }

    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];

    return cookieValue || '';
}

async function handlePushNotificationToggle(checkbox) {
    const statusDiv = document.getElementById('push-notification-status');

    if (checkbox.checked) {
        // User wants to enable push notifications
        if (!pushManager) {
            await initPushNotifications();
        }

        if (pushManager) {
            // Request permission
            const permissionGranted = await requestNotificationPermission();

            if (permissionGranted) {
                // Subscribe to push notifications
                const subscribed = await subscribeToPushNotifications();

                if (subscribed) {
                    statusDiv.innerHTML = '<small class="text-success"><i class="fas fa-check-circle me-1"></i>Push notifications enabled!</small>';
                    statusDiv.style.display = 'block';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                } else {
                    statusDiv.innerHTML = '<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Failed to enable push notifications</small>';
                    statusDiv.style.display = 'block';
                    checkbox.checked = false; // Revert the checkbox
                }
            } else {
                statusDiv.innerHTML = '<small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Browser permission denied. Please allow notifications in your browser settings.</small>';
                statusDiv.style.display = 'block';
                checkbox.checked = false; // Revert the checkbox
            }
        } else {
            statusDiv.innerHTML = '<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Push notifications not supported in this browser</small>';
            statusDiv.style.display = 'block';
            checkbox.checked = false; // Revert the checkbox
        }
    } else {
        // User wants to disable push notifications
        if (pushManager && pushManager.isSubscribed) {
            const unsubscribed = await unsubscribeFromPushNotifications();

            if (unsubscribed) {
                statusDiv.innerHTML = '<small class="text-info"><i class="fas fa-info-circle me-1"></i>Push notifications disabled</small>';
                statusDiv.style.display = 'block';
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 2000);
            }
        }
    }
}

// Initialize push notifications when page loads
document.addEventListener('DOMContentLoaded', async () => {
    await initPushNotifications();
});
</script>
{% endblock %}
